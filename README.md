# ClinicalNotes2FHIR
This is a NLP Phenotyping Pipeline for extracting and classifying the i2b2 obesity challenge dataset from 2008. 
The unstructured clinical notes in the dataset are processed and analyzed, so that FHIR R4 resources are generated. 
This FHIR resources are futher used to classifiy patients into multiple classes, which are defined in the obesity challenge. 

![NLP-Pipeline_english](https://user-images.githubusercontent.com/84778375/155688750-f773021c-5a93-4969-ade8-765bc7c363d7.png)


## Preparation
Before creating FHIR resources, the dataset has to be prepared in order to be analyzed with cTakes. Therefore for each patient, an own file with the clinical note as input has to be created. In the `preparation`-folder, the java-class `XMLParser.java` can be used to create separate files for each clinical note in the i2b2 obesity dataset. After that, the files can be processed with the java-class `DefaultClinicalPipeline.java` in the same directory. Of course, Apache cTakes has to be installed prior to this step (https://ctakes.apache.org/). As a result, cTakes generates annotations for each clinical note, which can be further processed. Because cTakes generates XMI-files which are not very common, these files can be parsed to generate CSV-files. The `Python ctakes parser`, available here https://github.com/titu1994/PyCTakesParser, is used in the `parseDataset` script to create these CSV-files for each annotated file. The `ctakes parser` is also customized, so that all available cTakes annotations are created in the csv-files. The original `ctakes parser` is limited to only a few semantic types. These customizations are made in the `ctakes_parser` package in this repository.

## Extracting FHIR Resources
After the data is preprocessed, FHIR Resources can be extracted from the annotated files. To extract diseases, the `extractDiseases` script can be used. FHIR Condition Resources are generated for each patient in the dataset and posted on a self hosted FHIR server with the `SMART FHIR client` (https://github.com/smart-on-fhir/client-py). The `fhir client` specific code is available in the `FHIRHelper` script, where the url and port to the FHIR server can be changed. MedicationStatement- and Procedure-Resources are created similar in the `extractMedications` and `extractProcedures` scripts. Symptoms are created also as FHIR Conditions in the `extractSignSymptom` script.

## Classification
Before classification of the FHIR resources can be achieved, the created FHIR Resources for each patient have to be summarized in a table. Therefore the `addFhirColumnTraining` and `addFhirColumnTest` scripts can be used to add FHIR data to the judgements of the experts within the obesity challenge. A new column `fhir_info` is added to the dataset and can be later used to classify the patients according to the different classes. For the classification, instead of using the clinical notes as a input for the algorithm, the FHIR data is used to assign patients to the different classes. The `evaluation` script first generated `TF-IDF` features for these FHIR Resources, selects only the k-best Features and classifies the data with the `RandomForest` algorithm. Note that these steps can be customized and changed to the own needs. Other feature extraction methods and classifiers can be used accordingly.
